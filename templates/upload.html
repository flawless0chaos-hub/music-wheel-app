<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”×¢×œ××ª ××œ×‘×•× - Music Wheel</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Rubik', sans-serif; 
            background: #0a0a0a; 
            color: #fff; 
            padding: 20px;
            min-height: 100vh;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        h1 { 
            text-align: center; 
            font-size: 32px; 
            margin-bottom: 40px;
            background: linear-gradient(135deg, #ff1493, #ff69b4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .card {
            background: #111;
            border: 1px solid #222;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #ff1493;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }
        
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #ff1493;
            background: rgba(255,255,255,0.08);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff1493, #ff69b4);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 20, 147, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .styles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .style-item {
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .style-color {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .style-name {
            flex: 1;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: white;
            font-size: 13px;
        }
        
        .remove-style {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255,0,0,0.2);
            border: 1px solid rgba(255,0,0,0.4);
            color: #ff4444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-style-btn {
            width: 100%;
            padding: 12px;
            background: rgba(255,20,147,0.1);
            border: 2px dashed rgba(255,20,147,0.3);
            border-radius: 8px;
            color: #ff1493;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
        }
        
        .tracks-section {
            margin-top: 30px;
        }
        
        .track-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .track-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #ff69b4;
        }
        
        .track-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .upload-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tab {
            flex: 1;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab.active {
            background: rgba(255,20,147,0.2);
            border-color: #ff1493;
            color: #ff1493;
        }
        
        .upload-option {
            display: none;
        }
        
        .upload-option.active {
            display: block;
        }
        
        .file-input-wrapper {
            position: relative;
            padding: 40px;
            background: rgba(255,255,255,0.03);
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
        }
        
        .file-input-wrapper:hover {
            border-color: #ff1493;
            background: rgba(255,20,147,0.05);
        }
        
        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .progress {
            margin-top: 30px;
            padding: 20px;
            background: rgba(29,169,160,0.1);
            border: 1px solid rgba(29,169,160,0.3);
            border-radius: 8px;
            display: none;
        }
        
        .progress.show {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff1493, #ff69b4);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s;
        }
        
        .success-message {
            margin-top: 20px;
            padding: 15px;
            background: rgba(29,169,160,0.2);
            border: 1px solid rgba(29,169,160,0.4);
            border-radius: 8px;
            color: #1da9a0;
            text-align: center;
            display: none;
        }
        
        .success-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ ×”×¢×œ××ª ××œ×‘×•× ×—×“×©</h1>
        
        <!-- Album Setup -->
        <div class="card">
            <div class="card-title">×”×’×“×¨×•×ª ××œ×‘×•×</div>
            
            <div class="form-group">
                <label>×©× ×”××œ×‘×•×</label>
                <input type="text" id="albumName" placeholder="×”×›× ×¡ ×©× ××œ×‘×•×...">
            </div>
            
            <div class="form-group">
                <label>××¡×¤×¨ ×©×™×¨×™×</label>
                <input type="number" id="trackCount" value="8" min="1" max="20">
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="useTransitions">
                    <label for="useTransitions" style="margin: 0;">×”×× ×œ×”×©×ª××© ×‘××¢×‘×¨×•× ×™× (Transitions) ×‘×™×Ÿ ×¡×’× ×•× ×•×ª?</label>
                </div>
            </div>
        </div>
        
        <!-- Styles Setup -->
        <div class="card">
            <div class="card-title">×”×’×“×¨×ª ×¡×’× ×•× ×•×ª / ×§×˜×’×•×¨×™×•×ª</div>
            <p style="color: rgba(255,255,255,0.6); margin-bottom: 15px;">
                ×›×œ ×©×™×¨ ×™×›×œ×•×œ ××¡×¤×¨ ×¡×’× ×•× ×•×ª ×©×•× ×™×. ×”×’×“×¨ ×›××” ×¡×’× ×•× ×•×ª ×©××ª×” ×¨×•×¦×”!
            </p>
            
            <div class="styles-grid" id="stylesGrid">
                <!-- Styles will be added here dynamically -->
            </div>
            
            <button class="add-style-btn" id="addStyleBtn">+ ×”×•×¡×£ ×¡×’× ×•×Ÿ ×—×“×©</button>
        </div>
        
        <!-- Create Album Button -->
        <button class="btn btn-primary" id="createAlbumBtn" style="width: 100%; padding: 16px; font-size: 16px;">
            ×¦×•×¨ ××œ×‘×•× ×•×”××©×š ×œ×”×¢×œ××ª ×©×™×¨×™×
        </button>
        
        <!-- Tracks Upload Section (Hidden until album is created) -->
        <div id="tracksSection" style="display: none;">
            <div class="tracks-section" id="tracksContainer">
                <!-- Track cards will be added here dynamically -->
            </div>
            
            <button class="btn btn-primary" id="uploadAllBtn" style="width: 100%; padding: 16px; font-size: 16px; margin-top: 20px;">
                ğŸš€ ×”×¢×œ×” ××ª ×›×œ ×”×©×™×¨×™×
            </button>
        </div>
        
        <!-- Progress -->
        <div class="progress" id="progressSection">
            <div id="progressText">××¢×œ×”...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        
        <div class="success-message" id="successMessage">
            âœ… ×”××œ×‘×•× ×”×•×¢×œ×” ×‘×”×¦×œ×—×”! 
            <a href="/" style="color: #1da9a0; text-decoration: underline;">×—×–×•×¨ ×œ× ×’×Ÿ</a>
        </div>
    </div>
    
    <script src="/static/js/upload-api.js"></script>
    <script src="/static/js/upload-storage.js"></script>
    <script>
        // Configuration
        const defaultColors = [
            '#d13b3b', '#9b3480', '#513c99', '#2373a1', '#1da9a0',
            '#25a56a', '#c6a527', '#d96c27', '#c73a63', '#7c4199',
            '#3498db', '#e74c3c', '#9b59b6', '#1abc9c', '#f39c12'
        ];
        
        let styleCount = 0;
        let currentAlbumName = '';
        let albumStyles = [];
        
        // Initialize with 5 default styles
        window.addEventListener('DOMContentLoaded', () => {
            for (let i = 0; i < 5; i++) {
                addStyle();
            }
        });
        
        // Add Style
        document.getElementById('addStyleBtn').addEventListener('click', addStyle);
        
        function addStyle() {
            const grid = document.getElementById('stylesGrid');
            const colorIndex = styleCount % defaultColors.length;
            const color = defaultColors[colorIndex];
            
            const styleDiv = document.createElement('div');
            styleDiv.className = 'style-item';
            styleDiv.dataset.index = styleCount;
            
            styleDiv.innerHTML = `
                <input type="color" class="style-color" value="${color}">
                <input type="text" class="style-name" placeholder="×©× ×¡×’× ×•×Ÿ..." value="${getDefaultStyleName(styleCount)}">
                <button class="remove-style" onclick="removeStyle(${styleCount})">Ã—</button>
            `;
            
            grid.appendChild(styleDiv);
            styleCount++;
        }
        
        function getDefaultStyleName(index) {
            const names = ['Rock', 'Funk', 'Hip Hop', 'Blues', 'Jazz', 'Pop', 'Reggae', 'Metal', 'Classical', 'Electronic'];
            return names[index] || `Style ${index + 1}`;
        }
        
        function removeStyle(index) {
            const style = document.querySelector(`[data-index="${index}"]`);
            if (style && document.querySelectorAll('.style-item').length > 1) {
                style.remove();
            } else {
                alert('×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤×—×•×ª ×¡×’× ×•×Ÿ ××—×“!');
            }
        }
        
        // Create Album
        document.getElementById('createAlbumBtn').addEventListener('click', async () => {
            const albumName = document.getElementById('albumName').value.trim();
            const trackCount = parseInt(document.getElementById('trackCount').value);
            const useTransitions = document.getElementById('useTransitions').checked;
            
            if (!albumName) {
                alert('× × ×œ×”×›× ×™×¡ ×©× ××œ×‘×•×');
                return;
            }
            
            // Collect styles
            const styles = [];
            document.querySelectorAll('.style-item').forEach(item => {
                const name = item.querySelector('.style-name').value.trim();
                if (name) {
                    styles.push(name);
                }
            });
            
            if (styles.length === 0) {
                alert('× × ×œ×”×•×¡×™×£ ×œ×¤×—×•×ª ×¡×’× ×•×Ÿ ××—×“');
                return;
            }
            
            // Store for later use
            currentAlbumName = albumName;
            albumStyles = styles;
            
            // Create album via API
            try {
                const response = await fetch('/api/album/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        album: albumName,
                        trackCount: trackCount,
                        styles: styles,
                        useTransitions: useTransitions
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('âœ… ×”××œ×‘×•× × ×•×¦×¨ ×‘×”×¦×œ×—×”!');
                    generateTrackForms(trackCount, styles, useTransitions);
                    document.getElementById('tracksSection').style.display = 'block';
                    document.getElementById('createAlbumBtn').style.display = 'none';
                } else {
                    alert('×©×’×™××”: ' + data.message);
                }
            } catch (error) {
                alert('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª ×œ×©×¨×ª: ' + error.message);
            }
        });
        
        // Generate Track Forms
        function generateTrackForms(trackCount, styles, useTransitions) {
            const container = document.getElementById('tracksContainer');
            container.innerHTML = '';
            
            for (let i = 1; i <= trackCount; i++) {
                const trackCard = document.createElement('div');
                trackCard.className = 'track-card';
                trackCard.dataset.track = i;
                
                let html = `
                    <div class="track-header">ğŸµ ×©×™×¨ ${i}</div>
                    <div class="track-info">
                        <div class="form-group">
                            <label>×©× ×”×©×™×¨</label>
                            <input type="text" class="track-name" placeholder="×©× ×”×©×™×¨...">
                        </div>
                        <div class="form-group">
                            <label>×©× ×”×××Ÿ</label>
                            <input type="text" class="track-artist" placeholder="×©× ×”×××Ÿ...">
                        </div>
                    </div>
                `;
                
                // Add upload options for each style
                styles.forEach((style, idx) => {
                    const styleKey = style.toLowerCase().replace(/ /g, '_');
                    html += `
                        <div style="margin-top: 20px;">
                            <strong style="color: ${defaultColors[idx % defaultColors.length]}">×¡×’× ×•×Ÿ: ${style}</strong>
                            <div class="upload-tabs" style="margin-top: 10px;">
                                <div class="tab active" onclick="switchTab(${i}, '${styleKey}', 'file')">ğŸ“ ×§×•×‘×¥ MP3</div>
                                <div class="tab" onclick="switchTab(${i}, '${styleKey}', 'youtube')">â–¶ï¸ YouTube</div>
                            </div>
                            
                            <div class="upload-option active" id="upload-file-${i}-${styleKey}">
                                <div class="file-input-wrapper">
                                    <input type="file" accept="audio/*" data-track="${i}" data-style="${styleKey}" data-type="audio">
                                    <div>ğŸ“ ×’×¨×•×¨ ×§×•×‘×¥ MP3 ××• ×œ×—×¥ ×œ×”×¢×œ××”</div>
                                </div>
                            </div>
                            
                            <div class="upload-option" id="upload-youtube-${i}-${styleKey}">
                                <input type="text" placeholder="×”×›× ×¡ ×§×™×©×•×¨ YouTube..." 
                                       data-track="${i}" data-style="${styleKey}" data-type="youtube"
                                       style="margin-bottom: 10px;">
                            </div>
                            
                            <div class="form-group" style="margin-top: 10px;">
                                <label>××™×œ×™× (××•×¤×¦×™×•× ×œ×™)</label>
                                <textarea rows="3" placeholder="××™×œ×™ ×”×©×™×¨..." 
                                          data-track="${i}" data-style="${styleKey}" data-type="lyrics"></textarea>
                            </div>
                        </div>
                    `;
                    
                    if (useTransitions) {
                        html += `
                            <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                                <strong style="font-size: 13px;">××¢×‘×¨×•×Ÿ (Transition) - ${style}</strong>
                                <div class="upload-tabs" style="margin-top: 10px;">
                                    <div class="tab active" onclick="switchTab(${i}, '${styleKey}_transition', 'file')">ğŸ“ MP3</div>
                                    <div class="tab" onclick="switchTab(${i}, '${styleKey}_transition', 'youtube')">â–¶ï¸ YouTube</div>
                                </div>
                                
                                <div class="upload-option active" id="upload-file-${i}-${styleKey}_transition">
                                    <div class="file-input-wrapper" style="padding: 20px;">
                                        <input type="file" accept="audio/*" data-track="${i}" data-style="${styleKey}" data-type="transition_audio">
                                        <div>ğŸ“ ××¢×‘×¨×•×Ÿ MP3</div>
                                    </div>
                                </div>
                                
                                <div class="upload-option" id="upload-youtube-${i}-${styleKey}_transition">
                                    <input type="text" placeholder="YouTube..." 
                                           data-track="${i}" data-style="${styleKey}" data-type="transition_youtube">
                                </div>
                            </div>
                        `;
                    }
                });
                
                trackCard.innerHTML = html;
                container.appendChild(trackCard);
            }
        }
        
        // Switch between File/YouTube tabs
        function switchTab(track, style, type) {
            const tabs = document.querySelectorAll(`[onclick*="switchTab(${track}, '${style}',"]`);
            const fileOption = document.getElementById(`upload-file-${track}-${style}`);
            const youtubeOption = document.getElementById(`upload-youtube-${track}-${style}`);
            
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            if (type === 'file') {
                fileOption.classList.add('active');
                youtubeOption.classList.remove('active');
            } else {
                fileOption.classList.remove('active');
                youtubeOption.classList.add('active');
            }
        }
        
        // Upload All Tracks
        document.getElementById('uploadAllBtn').addEventListener('click', async () => {
            const tracks = document.querySelectorAll('.track-card');
            const progress = document.getElementById('progressSection');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progress.classList.add('show');
            
            let completed = 0;
            const total = tracks.length;
            
            for (const trackCard of tracks) {
                const trackNum = parseInt(trackCard.dataset.track);
                const trackName = trackCard.querySelector('.track-name').value || `Track ${trackNum}`;
                const trackArtist = trackCard.querySelector('.track-artist').value || 'Unknown Artist';
                
                progressText.textContent = `××¢×œ×” ×©×™×¨ ${trackNum} ××ª×•×š ${total}...`;
                
                const formData = new FormData();
                formData.append('album', currentAlbumName);
                formData.append('number', trackNum);
                formData.append('name', trackName);
                formData.append('artist', trackArtist);
                
                // Collect files
                const files = trackCard.querySelectorAll('input[type="file"]');
                files.forEach(input => {
                    if (input.files.length > 0) {
                        const style = input.dataset.style;
                        const type = input.dataset.type;
                        const key = type === 'transition_audio' ? `transition_${style}` : `track_${style}`;
                        formData.append(key, input.files[0]);
                    }
                });
                
                // Collect YouTube links
                const youtubeInputs = trackCard.querySelectorAll('input[data-type="youtube"], input[data-type="transition_youtube"]');
                youtubeInputs.forEach(input => {
                    if (input.value.trim()) {
                        const style = input.dataset.style;
                        const type = input.dataset.type;
                        const key = type === 'transition_youtube' ? `youtube_transition_${style}` : `youtube_track_${style}`;
                        formData.append(key, input.value.trim());
                    }
                });
                
                // Collect lyrics
                const lyrics = trackCard.querySelectorAll('textarea[data-type="lyrics"]');
                lyrics.forEach(textarea => {
                    if (textarea.value.trim()) {
                        const style = textarea.dataset.style;
                        const blob = new Blob([textarea.value], { type: 'text/plain' });
                        formData.append(`lyrics_${style}`, blob, 'lyrics.txt');
                    }
                });
                
                // Upload
                try {
                    await fetch('/api/upload/track', {
                        method: 'POST',
                        body: formData
                    });
                    
                    completed++;
                    const percent = Math.round((completed / total) * 100);
                    progressFill.style.width = percent + '%';
                    
                } catch (error) {
                    console.error('Error uploading track:', error);
                }
            }
            
            progressText.textContent = 'âœ… ×”×¡×ª×™×™×!';
            document.getElementById('successMessage').classList.add('show');
        });
    </script>
</body>
</html>
