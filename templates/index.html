<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Wheel Player</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-bg: #0a0e1a;
            --secondary-bg: rgba(255, 255, 255, 0.05);
            --accent-color: #00d4ff;
            --text-color: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --bubble-bg: rgba(255, 255, 255, 0.12);
            --bubble-hover: rgba(255, 255, 255, 0.18);
        }

        body {
            font-family: 'Heebo', 'Orbitron', sans-serif;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 100%);
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ==================== Container ==================== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ==================== Info Bubbles (Top) ==================== */
        .info-section {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0 50px 0;
            perspective: 1000px;
        }

        .info-bubble {
            background: var(--bubble-bg);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 15px 30px;
            border: none;
            color: var(--text-color);
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            line-height: 1.5;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            cursor: default;
            min-width: 120px;
            max-width: 200px;
        }

        .info-bubble:hover {
            background: var(--bubble-hover);
            transform: translateY(-5px) scale(1.05);
        }

        /* Magnetic effect for bubbles */
        .info-bubble.magnetic {
            transform: translate(var(--mouse-x, 0px), var(--mouse-y, 0px)) scale(1.02);
        }

        /* ==================== Wheel Container ==================== */
        .wheel-container {
            position: relative;
            width: 600px;
            height: 600px;
            margin: 0 auto;
        }

        /* Main Wheel */
        .wheel {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transition: transform 0.5s ease;
        }

        /* Wheel Rings */
        .wheel-ring {
            position: absolute;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wheel-ring:hover {
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.02);
        }

        /* Track Dots on Rings */
        .track-dot {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .track-dot:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.15);
        }

        .track-dot.active {
            background: white;
            transform: scale(1.2);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.6);
        }

        /* Play/Pause Icon in Active Dot */
        .play-icon {
            width: 0;
            height: 0;
            border-left: 12px solid #000;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            margin-left: 3px;
            display: none;
        }

        .pause-icon {
            width: 12px;
            height: 16px;
            display: none;
            position: relative;
        }

        .pause-icon::before,
        .pause-icon::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 100%;
            background: #000;
        }

        .pause-icon::before {
            left: 0;
        }

        .pause-icon::after {
            right: 0;
        }

        .track-dot.active .play-icon,
        .track-dot.active.playing .pause-icon {
            display: block;
        }

        .track-dot.active.playing .play-icon {
            display: none;
        }

        /* ==================== Control Bubbles (Bottom) ==================== */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 50px;
        }

        .control-bubble {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bubble-bg);
            backdrop-filter: blur(10px);
            border: none;
            color: var(--text-color);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-bubble:hover {
            background: var(--bubble-hover);
            transform: scale(1.1);
        }

        .control-bubble:active {
            transform: scale(0.95);
        }

        /* Volume Slider Tongue */
        .volume-container {
            position: relative;
        }

        .volume-slider {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            transform-origin: bottom;
            background: var(--bubble-bg);
            backdrop-filter: blur(15px);
            padding: 20px 15px;
            border-radius: 25px;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
        }

        .volume-slider.active {
            transform: translateX(-50%) scale(1);
            opacity: 1;
            pointer-events: all;
        }

        .volume-slider input[type="range"] {
            -webkit-appearance: none;
            width: 150px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            transform: rotate(-90deg);
        }

        .volume-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Lyrics Panel */
        .lyrics-container {
            position: relative;
        }

        .lyrics-panel {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            transform-origin: bottom;
            background: var(--bubble-bg);
            backdrop-filter: blur(15px);
            padding: 20px;
            border-radius: 20px;
            min-width: 300px;
            max-width: 400px;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .lyrics-panel.active {
            transform: translateX(-50%) scale(1);
            opacity: 1;
            pointer-events: all;
        }

        .lyrics-text {
            color: var(--text-secondary);
            line-height: 1.8;
            font-size: 14px;
            white-space: pre-wrap;
        }

        /* Category Bubbles Container */
        .categories-container {
            position: relative;
        }

        .category-bubbles {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .category-bubbles.active {
            opacity: 1;
            pointer-events: all;
        }

        .category-bubble {
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            transform: scale(0);
            animation: bubblePop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .category-bubble:nth-child(1) { animation-delay: 0.05s; }
        .category-bubble:nth-child(2) { animation-delay: 0.1s; }
        .category-bubble:nth-child(3) { animation-delay: 0.15s; }
        .category-bubble:nth-child(4) { animation-delay: 0.2s; }
        .category-bubble:nth-child(5) { animation-delay: 0.25s; }

        @keyframes bubblePop {
            to {
                transform: scale(1);
            }
        }

        .category-bubble:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }

        /* Social Section */
        .social-section {
            margin-top: 50px;
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .social-bubble {
            background: var(--bubble-bg);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            color: var(--text-color);
            font-size: 16px;
        }

        .social-bubble:hover {
            background: var(--bubble-hover);
            transform: translateY(-3px);
        }

        .social-bubble.liked {
            background: rgba(255, 107, 107, 0.2);
        }

        .comments-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--primary-bg);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .comments-modal.active {
            display: block;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }

        .modal-overlay.active {
            display: block;
        }

        .comment-input {
            width: 100%;
            padding: 15px;
            background: var(--bubble-bg);
            border: none;
            border-radius: 15px;
            color: var(--text-color);
            margin-top: 20px;
            resize: vertical;
            font-family: inherit;
        }

        .comment-item {
            background: var(--bubble-bg);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
        }

        .comment-user {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .comment-text {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Audio Player (Hidden) */
        #audioPlayer {
            display: none;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .wheel-container {
                width: 400px;
                height: 400px;
            }

            .info-bubble {
                font-size: 12px;
                padding: 12px 20px;
            }

            .control-bubble {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Info Bubbles (Track Details) -->
        <div class="info-section" id="infoSection">
            <div class="info-bubble" id="trackNameBubble">Track Name</div>
            <div class="info-bubble" id="artistBubble">Artist Name</div>
            <div class="info-bubble" id="styleBubble">Style</div>
        </div>

        <!-- Wheel Container -->
        <div class="wheel-container">
            <div class="wheel" id="mainWheel">
                <!-- Rings and dots will be generated by JavaScript -->
            </div>
        </div>

        <!-- Control Bubbles -->
        <div class="controls">
            <!-- Volume Control -->
            <div class="volume-container">
                <button class="control-bubble" id="volumeBtn" title="Volume">
                    
                </button>
                <div class="volume-slider" id="volumeSlider">
                    <input type="range" min="0" max="100" value="70" id="volumeControl">
                </div>
            </div>

            <!-- Lyrics Control -->
            <div class="lyrics-container">
                <button class="control-bubble" id="lyricsBtn" title="Lyrics">
                    
                </button>
                <div class="lyrics-panel" id="lyricsPanel">
                    <div class="lyrics-text" id="lyricsText">No lyrics available</div>
                </div>
            </div>

            <!-- Categories Control -->
            <div class="categories-container">
                <button class="control-bubble" id="categoriesBtn" title="Categories">
                    
                </button>
                <div class="category-bubbles" id="categoryBubbles">
                    <!-- Category bubbles generated by JS -->
                </div>
            </div>
        </div>

        <!-- Social Section -->
        <div class="social-section">
            <button class="social-bubble" id="likeBtn">
                わ <span id="likeCount">0</span>
            </button>
            <button class="social-bubble" id="commentBtn">
                 <span id="commentCount">0</span>
            </button>
        </div>
    </div>

    <!-- Audio Player -->
    <audio id="audioPlayer" preload="metadata"></audio>

    <!-- Comments Modal -->
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="comments-modal" id="commentsModal">
        <h3>转转</h3>
        <div id="commentsList"></div>
        <textarea class="comment-input" id="commentInput" placeholder="住祝 转..." rows="3"></textarea>
        <button class="social-bubble" id="submitComment" style="margin-top: 10px;">砖</button>
    </div>

    <script>
        // Global state
        const state = {
            currentAlbum: null,
            currentTrack: null,
            currentStyle: null,
            isPlaying: false,
            userId: localStorage.getItem('userId') || 'user_' + Date.now()
        };

        // Store user ID
        if (!localStorage.getItem('userId')) {
            localStorage.setItem('userId', state.userId);
        }

        const audioPlayer = document.getElementById('audioPlayer');
        const volumeControl = document.getElementById('volumeControl');

        // Initialize
        async function init() {
            try {
                // Load albums list
                const response = await fetch('/api/albums/list');
                const data = await response.json();
                
                if (data.status === 'success' && data.albums.length > 0) {
                    // Load first album
                    await loadAlbum(data.albums[0]);
                } else {
                    document.querySelector('.container').innerHTML = '<div class="loading">No albums found. Please upload content.</div>';
                }
            } catch (error) {
                console.error('Error initializing:', error);
                document.querySelector('.container').innerHTML = '<div class="loading">Error loading album</div>';
            }
        }

        // Load album
        async function loadAlbum(albumName) {
            try {
                const response = await fetch(`/api/album/load?album=${encodeURIComponent(albumName)}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    state.currentAlbum = data.data;
                    renderWheel();
                    renderCategories();
                }
            } catch (error) {
                console.error('Error loading album:', error);
            }
        }

        // Render wheel
        function renderWheel() {
            const wheel = document.getElementById('mainWheel');
            wheel.innerHTML = '';
            
            const tracks = Object.values(state.currentAlbum.tracks);
            const trackCount = tracks.length;
            const centerX = 300;
            const centerY = 300;
            
            tracks.forEach((track, index) => {
                const radius = 200 - (index * 20);
                const angle = (index / trackCount) * Math.PI * 2 - Math.PI / 2;
                const x = centerX + radius * Math.cos(angle) - 20;
                const y = centerY + radius * Math.sin(angle) - 20;
                
                const dot = document.createElement('div');
                dot.className = 'track-dot';
                dot.style.left = x + 'px';
                dot.style.top = y + 'px';
                dot.dataset.trackNumber = track.number;
                
                dot.innerHTML = `
                    <div class="play-icon"></div>
                    <div class="pause-icon"></div>
                `;
                
                dot.addEventListener('click', () => selectTrack(track.number));
                
                wheel.appendChild(dot);
            });
        }

        // Render category bubbles
        function renderCategories() {
            const container = document.getElementById('categoryBubbles');
            container.innerHTML = '';
            
            state.currentAlbum.styles.forEach(style => {
                const bubble = document.createElement('div');
                bubble.className = 'category-bubble';
                bubble.style.backgroundColor = style.color;
                bubble.textContent = style.name;
                bubble.addEventListener('click', () => selectStyle(style.key));
                container.appendChild(bubble);
            });
        }

        // Select track
        async function selectTrack(trackNumber) {
            state.currentTrack = state.currentAlbum.tracks[trackNumber];
            
            // Update UI
            document.querySelectorAll('.track-dot').forEach(dot => {
                dot.classList.remove('active', 'playing');
            });
            
            const activeDot = document.querySelector(`[data-track-number="${trackNumber}"]`);
            if (activeDot) {
                activeDot.classList.add('active');
            }
            
            // Update info bubbles
            document.getElementById('trackNameBubble').textContent = state.currentTrack.name;
            document.getElementById('artistBubble').textContent = state.currentTrack.artist;
            
            // Load social data
            await loadSocialData();
            
            // If style selected, play
            if (state.currentStyle) {
                playTrack();
            }
        }

        // Select style
        function selectStyle(styleKey) {
            state.currentStyle = styleKey;
            const styleName = state.currentAlbum.styles.find(s => s.key === styleKey)?.name;
            document.getElementById('styleBubble').textContent = styleName || styleKey;
            
            if (state.currentTrack) {
                playTrack();
            }
        }

        // Play track
        function playTrack() {
            if (!state.currentTrack || !state.currentStyle) return;
            
            const styleData = state.currentTrack.styles[state.currentStyle];
            if (!styleData || !styleData.url) {
                alert('Track not available for this style');
                return;
            }
            
            // Handle YouTube or file
            if (styleData.type === 'youtube') {
                // For YouTube, we'd need an embedded player or YouTube API
                window.open(styleData.url, '_blank');
            } else {
                audioPlayer.src = styleData.url;
                audioPlayer.play();
                state.isPlaying = true;
                
                const activeDot = document.querySelector('.track-dot.active');
                if (activeDot) {
                    activeDot.classList.add('playing');
                }
            }
            
            // Load lyrics if available
            if (styleData.lyrics_url) {
                fetch(styleData.lyrics_url)
                    .then(r => r.text())
                    .then(text => {
                        document.getElementById('lyricsText').textContent = text;
                    });
            }
        }

        // Toggle play/pause
        document.addEventListener('click', (e) => {
            const dot = e.target.closest('.track-dot.active');
            if (dot) {
                if (state.isPlaying) {
                    audioPlayer.pause();
                    state.isPlaying = false;
                    dot.classList.remove('playing');
                } else {
                    audioPlayer.play();
                    state.isPlaying = true;
                    dot.classList.add('playing');
                }
            }
        });

        // Volume control
        document.getElementById('volumeBtn').addEventListener('click', () => {
            document.getElementById('volumeSlider').classList.toggle('active');
        });

        volumeControl.addEventListener('input', (e) => {
            audioPlayer.volume = e.target.value / 100;
        });

        // Lyrics control
        document.getElementById('lyricsBtn').addEventListener('click', () => {
            document.getElementById('lyricsPanel').classList.toggle('active');
        });

        // Categories control
        document.getElementById('categoriesBtn').addEventListener('click', () => {
            document.getElementById('categoryBubbles').classList.toggle('active');
        });

        // Magnetic effect for info bubbles
        const infoBubbles = document.querySelectorAll('.info-bubble');
        document.addEventListener('mousemove', (e) => {
            infoBubbles.forEach(bubble => {
                const rect = bubble.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                const distX = e.clientX - centerX;
                const distY = e.clientY - centerY;
                const distance = Math.sqrt(distX * distX + distY * distY);
                
                if (distance < 150) {
                    const strength = (150 - distance) / 150;
                    const moveX = (distX / distance) * strength * 20;
                    const moveY = (distY / distance) * strength * 20;
                    
                    bubble.style.setProperty('--mouse-x', moveX + 'px');
                    bubble.style.setProperty('--mouse-y', moveY + 'px');
                    bubble.classList.add('magnetic');
                } else {
                    bubble.style.setProperty('--mouse-x', '0px');
                    bubble.style.setProperty('--mouse-y', '0px');
                    bubble.classList.remove('magnetic');
                }
            });
        });

        // Social features
        async function loadSocialData() {
            if (!state.currentTrack) return;
            
            const trackNum = state.currentTrack.number;
            document.getElementById('likeCount').textContent = state.currentTrack.social.likes;
            document.getElementById('commentCount').textContent = state.currentTrack.social.comments;
            
            // Check if user liked
            const likeBtn = document.getElementById('likeBtn');
            const liked = localStorage.getItem(`liked_${state.currentAlbum.albumName}_${trackNum}`);
            if (liked) {
                likeBtn.classList.add('liked');
            } else {
                likeBtn.classList.remove('liked');
            }
        }

        document.getElementById('likeBtn').addEventListener('click', async () => {
            if (!state.currentTrack) return;
            
            try {
                const response = await fetch('/api/social/like', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        album: state.currentAlbum.albumName,
                        track: state.currentTrack.number,
                        userId: state.userId
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    document.getElementById('likeCount').textContent = data.count;
                    
                    const likeBtn = document.getElementById('likeBtn');
                    if (data.liked) {
                        likeBtn.classList.add('liked');
                        localStorage.setItem(`liked_${state.currentAlbum.albumName}_${state.currentTrack.number}`, 'true');
                    } else {
                        likeBtn.classList.remove('liked');
                        localStorage.removeItem(`liked_${state.currentAlbum.albumName}_${state.currentTrack.number}`);
                    }
                }
            } catch (error) {
                console.error('Error toggling like:', error);
            }
        });

        document.getElementById('commentBtn').addEventListener('click', async () => {
            if (!state.currentTrack) return;
            
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('commentsModal').classList.add('active');
            
            // Load comments
            try {
                const response = await fetch(`/api/social/comments?album=${encodeURIComponent(state.currentAlbum.albumName)}&track=${state.currentTrack.number}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const list = document.getElementById('commentsList');
                    list.innerHTML = data.comments.map(c => `
                        <div class="comment-item">
                            <div class="comment-user">${c.user}</div>
                            <div class="comment-text">${c.text}</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading comments:', error);
            }
        });

        document.getElementById('submitComment').addEventListener('click', async () => {
            const input = document.getElementById('commentInput');
            const text = input.value.trim();
            
            if (!text || !state.currentTrack) return;
            
            try {
                const userName = prompt('Enter your name:') || 'Anonymous';
                
                const response = await fetch('/api/social/comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        album: state.currentAlbum.albumName,
                        track: state.currentTrack.number,
                        userName,
                        comment: text
                    })
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    input.value = '';
                    document.getElementById('commentBtn').click(); // Reload comments
                }
            } catch (error) {
                console.error('Error adding comment:', error);
            }
        });

        document.getElementById('modalOverlay').addEventListener('click', () => {
            document.getElementById('modalOverlay').classList.remove('active');
            document.getElementById('commentsModal').classList.remove('active');
        });

        // Start
        init();
    </script>
</body>
</html>
